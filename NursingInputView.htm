<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>NTWC Nursing CIR Reporting Form</title>
    <link rel="stylesheet" href="cir-style.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        /* Optional styling to improve table form appearance */
        table {
            border-collapse: collapse;
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
        }

        td, th {
            padding: 8px 12px;
            vertical-align: top;
            border: 1px solid #ccc;
        }

        legend {
            font-weight: bold;
            margin-top: 20px;
            margin-bottom: 8px;
        }

        .radio-group label {
            margin-right: 12px;
        }

        textarea {
            width: 100%;
            box-sizing: border-box;
        }

        /* New: set fixed column widths with 1:3 ratio */
        table td:first-child {
            width: 25%; /* 1 part */
            white-space: nowrap;
        }

        table td:last-child {
            width: 75%; /* 3 parts */
        }
    </style>
</head>
<body>
<h1>NTWC Nursing CIR Reporting Form</h1>
<form id="nursingForm">

    <fieldset>
        <legend>Patient</legend>
        <table>
            <tbody>
            <tr>
                <td><label for="location">Location:</label></td>
                <td>
                    <select id="location" name="location">
                        <option value="">Select Location</option>
                        <option value="tmh">TMH</option>
                        <option value="poh">POH</option>
                        <option value="tswh">TSWH</option>
                        <option value="others">Others</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="patientName">Name:</label></td>
                <td><input type="text" id="patientName" name="patientName"/></td>
            </tr>
            <tr>
                <td><label for="sex">Sex:</label></td>
                <td>
                    <select id="sex" name="sex">
                        <option value="">Select Sex</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="age">Age:</label></td>
                <td><input type="number" id="age" name="age" min="0"/></td>
            </tr>
            <tr>
                <td><label for="ward">Ward:</label></td>
                <td><input type="text" id="ward" name="ward"/></td>
            </tr>
            <tr>
                <td><label for="bed">Bed:</label></td>
                <td><input type="text" id="bed" name="bed"/></td>
            </tr>
            <tr>
                <td><label for="patientHN">Patient HN Number:</label></td>
                <td><input type="text" id="patientHN" name="patientHN"/></td>
            </tr>
            <tr>
                <td><label for="timeArriveOT">Time Arriving into OT:</label></td>
                <td><input type="time" id="timeArriveOT" name="timeArriveOT"/></td>
            </tr>
            <tr>
                <td><label for="generalConditionBefore">General Condition before Operation:</label></td>
                <td><input type="text" id="generalConditionBefore" name="generalConditionBefore"/></td>
            </tr>
            <tr>
                <td><label for="diagnosis">Diagnosis:</label></td>
                <td><input type="text" id="diagnosis" name="diagnosis"/></td>
            </tr>
            </tbody>
        </table>
    </fieldset>

    <fieldset>
        <legend>Operation</legend>
        <table>
            <tbody>
            <tr>
                <td><label for="operationDone">Operation Done:</label></td>
                <td><input type="text" id="operationDone" name="operationDone"/></td>
            </tr>
            <tr>
                <td><label for="previousOperation">Any Previous Operation:</label></td>
                <td><input type="text" id="previousOperation" name="previousOperation"/></td>
            </tr>
            <tr>
                <td><label for="surgeon">Surgeon:</label></td>
                <td><input type="text" id="surgeon" name="surgeon"/></td>
            </tr>
            <tr>
                <td><label for="operationStart">Time Commenced:</label></td>
                <td><input type="time" id="operationStart" name="operationStart"/></td>
            </tr>
            <tr>
                <td><label for="operationEnd">Time Completed:</label></td>
                <td><input type="time" id="operationEnd" name="operationEnd"/></td>
            </tr>
            </tbody>
        </table>
    </fieldset>

    <fieldset>
        <legend>Anaesthesia</legend>
        <table>
            <tbody>
            <tr>
                <td><label for="anaesthesiaAdministered">Anaesthesia Administered:</label></td>
                <td><input type="text" id="anaesthesiaAdministered" name="anaesthesiaAdministered"/></td>
            </tr>
            <tr>
                <td><label for="anaesthetist">Anaesthetist:</label></td>
                <td><input type="text" id="anaesthetist" name="anaesthetist"/></td>
            </tr>
            <tr>
                <td><label for="anaesthesiaStart">Time Commenced:</label></td>
                <td><input type="time" id="anaesthesiaStart" name="anaesthesiaStart"/></td>
            </tr>
            <tr>
                <td><label for="anaesthesiaEnd">Time Completed:</label></td>
                <td><input type="time" id="anaesthesiaEnd" name="anaesthesiaEnd"/></td>
            </tr>
            </tbody>
        </table>
    </fieldset>

    <fieldset>
        <legend>Nursing Staff</legend>
        <table>
            <tbody>
            <tr>
                <td><label for="scrubNurse">Scrub Nurse:</label></td>
                <td><input type="text" id="scrubNurse" name="scrubNurse"/></td>
            </tr>
            <tr>
                <td><label for="circulatingNurse">Circulating Nurse:</label></td>
                <td><input type="text" id="circulatingNurse" name="circulatingNurse"/></td>
            </tr>
            </tbody>
        </table>
    </fieldset>

    <fieldset>
        <legend>Detail</legend>
        <table>
            <tbody>
            <tr>
                <td><label for="detail">Details:</label></td>
                <td><textarea id="detail" name="detail" rows="5" placeholder="Enter details here..."></textarea></td>
            </tr>
            </tbody>
        </table>
    </fieldset>

    <fieldset>
        <legend>General Condition after Operation</legend>
        <table>
            <tbody>
            <tr>
                <td><label for="pulse">Pulse:</label></td>
                <td><input type="text" id="pulse" name="pulse"/></td>
            </tr>
            <tr>
                <td><label for="bp">BP:</label></td>
                <td><input type="text" id="bp" name="bp"/></td>
            </tr>
            <tr>
                <td><label for="respiration">Respiration:</label></td>
                <td><input type="text" id="respiration" name="respiration"/></td>
            </tr>
            <tr>
                <td><label for="timeLeavingOT">Time Leaving OT:</label></td>
                <td><input type="time" id="timeLeavingOT" name="timeLeavingOT"/></td>
            </tr>
            </tbody>
        </table>
    </fieldset>

    <fieldset>
        <legend>Reporting Officer</legend>
        <table>
            <tbody>
            <tr>
                <td><label for="reportingOfficer">Reporting Officer:</label></td>
                <td><input type="text" id="reportingOfficer" name="reportingOfficer"/></td>
            </tr>
            <tr>
                <td><label for="rank">Rank:</label></td>
                <td>
                    <select id="rank" name="rank">
                        <option value="">Select Rank</option>
                        <option value="EN">EN</option>
                        <option value="RN">RN</option>
                        <option value="APN">APN</option>
                        <option value="WM">WM</option>
                        <option value="DOM">DOM</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="appt">Appt:</label></td>
                <td><input type="text" id="appt" name="appt"/></td>
            </tr>
            </tbody>
        </table>
    </fieldset>

    <fieldset>
        <legend>Encryption Password</legend>
        <table>
            <tbody>
            <tr>
                <td><label for="encPassword">Password:</label></td>
                <td><input type="password" id="encPassword" required/></td>
            </tr>
            </tbody>
        </table>
    </fieldset>

    <button type="submit" class="btn">Submit (Data will be encrypted)</button>
</form>
<p><a href="index.htm">Back to Home</a></p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
    document.cookie.split(";").forEach(function (c) {
        document.cookie = c.replace(/^ +/, "")
            .replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
    });

function collectFormData() {
    return {
        location: document.getElementById('location').value || null,
        patientName: document.getElementById('patientName').value.trim() || null,
        sex: document.getElementById('sex').value || null,
        age: (() => {
            const val = document.getElementById('age').value;
            return val ? Number(val) : null;
        })(),
        ward: document.getElementById('ward').value.trim() || null,
        bed: document.getElementById('bed').value.trim() || null,
        patientHN: document.getElementById('patientHN').value.trim() || null,
        timeArriveOT: document.getElementById('timeArriveOT').value || null,
        generalConditionBefore: document.getElementById('generalConditionBefore').value.trim() || null,
        diagnosis: document.getElementById('diagnosis').value.trim() || null,
        operationDone: document.getElementById('operationDone').value.trim() || null,
        previousOperation: document.getElementById('previousOperation').value.trim() || null,
        surgeon: document.getElementById('surgeon').value.trim() || null,
        operationStart: document.getElementById('operationStart').value || null,
        operationEnd: document.getElementById('operationEnd').value || null,
        anaesthesiaAdministered: document.getElementById('anaesthesiaAdministered').value.trim() || null,
        anaesthetist: document.getElementById('anaesthetist').value.trim() || null,
        anaesthesiaStart: document.getElementById('anaesthesiaStart').value || null,
        anaesthesiaEnd: document.getElementById('anaesthesiaEnd').value || null,
        scrubNurse: document.getElementById('scrubNurse').value.trim() || null,
        circulatingNurse: document.getElementById('circulatingNurse').value.trim() || null,
        detail: document.getElementById('detail').value.trim() || null,
        pulse: document.getElementById('pulse').value.trim() || null,
        bp: document.getElementById('bp').value.trim() || null,
        respiration: document.getElementById('respiration').value.trim() || null,
        timeLeavingOT: document.getElementById('timeLeavingOT').value || null,
        reportingOfficer: document.getElementById('reportingOfficer').value.trim() || null,
        rank: document.getElementById('rank').value || null,
        appt: document.getElementById('appt').value.trim() || null,
        timestamp: new Date().toISOString(),
    };
}

    document.getElementById('nursingForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const password = document.getElementById('encPassword').value;
        if (!password) {
            alert('Encryption password is required.');
            return;
        }
        const formData = collectFormData();
        formData.formType = 'nursing';
        const ciphertext = CryptoJS.AES.encrypt(JSON.stringify(formData), password).toString();
        const API_URL = 'https://api-gm7mkhepka-uc.a.run.app/api/records';
        fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({encryptedData: ciphertext}),
        })
            .then((res) => {
                if (res.ok) {
                    alert('Data encrypted and saved to backend successfully!');
                    this.reset();
                } else {
                    alert('Failed to save data to backend.');
                }
            })
            .catch(() => {
                alert('Failed to connect to backend.');
            });
    });
</script>
</body>
</html>
